# DIFY Webhook統合ガイド

DIFYのWebhookトリガーを使用することで、APIキーをクライアント側に露出させずに、ワークフローを視覚的に設計できます。

## DIFYとは

DIFYは、ノーコードでAIアプリを開発できるプラットフォームです。

**主なメリット：**
- ✅ **APIキー管理が不要**（DIFY側で管理、Webhook方式ではAPIキー不要）
- ✅ **ワークフローを視覚的に設計できる**
- ✅ **複数のLLMモデル**（GPT-4、Claude、Geminiなど）に対応
- ✅ **無料プランから始められる**
- ✅ **オンプレミス対応**（セキュリティ要件が高い場合）
- ✅ **Webhook方式でセキュア**（APIキーをクライアント側に露出しない）

## セットアップ手順

### 1. DIFYアカウントの作成

1. [DIFY公式サイト](https://dify.ai/) にアクセス
2. アカウントを作成（無料プランから始められます）

### 2. ワークフローの作成

1. DIFYダッシュボードにログイン
2. 「新しいアプリを作成」をクリック
3. **「ワークフロー」**を選択（チャットではなくワークフロー）
4. アプリ名を入力（例：「3つの質問生成」）

### 3. ワークフローの設計

#### ステップ1: Webhookトリガーの設定

1. ワークフローエディタで「開始」ノードをクリック
2. 「トリガー」を「Webhook」に設定
3. 入力変数として `job` を追加（変数名は任意、例：`job`）

#### ステップ2: LLMノードの追加

1. 「LLM」ノードを追加
2. プロンプトを設定：

```
あなたは質問生成の専門家です。{{#job}}{{job}}{{/job}}という職業の人に対して、以下の条件を満たす3つの質問を生成してください：

1. 各質問は15文字以内であること
2. その職業の人にとって興味深く、答えやすい質問であること
3. Twitterでシェアしたくなるような質問であること
4. 承認欲求を満たすような質問であること

質問は番号付きリストで出力してください。各質問は改行で区切ってください。説明文や余計なテキストは不要です。
```

3. 変数 `{{#job}}{{job}}{{/job}}` を使用して、Webhookから受け取った `job` の値を参照

#### ステップ3: 出力ノードの設定

1. 「終了」ノードを追加
2. 出力変数を設定（例：`output` または `result`）
3. LLMノードの出力を終了ノードに接続

### 4. Webhook URLの取得

1. ワークフローを保存
2. 「公開」タブまたは「API」タブを開く
3. **Webhook URL**をコピー
   - 例: `https://api.dify.ai/v1/workflows/run?user=webhook&token=xxxxx`
   - または: `https://your-dify-instance.com/v1/workflows/run?user=webhook&token=xxxxx`

**注意**: Webhook URLには認証トークンが含まれている場合があります。このトークンは秘密にしてください。

### 5. フロントエンドの設定

`config.js` ファイルで、DIFY Webhook URLを設定します：

```javascript
// DIFY Webhook設定
window.DIFY_WEBHOOK_URL = 'https://api.dify.ai/v1/workflows/run?user=webhook&token=xxxxx';
```

**✅ セキュリティのメリット：**

- APIキーをクライアント側に露出させない
- Webhook URLは公開リポジトリに含めても比較的安全（ただし、トークンが含まれる場合は注意）
- DIFY側でAPIキーを管理

## DIFY Webhookエンドポイント

DIFYのWebhookエンドポイントは、DIFYのバージョンやデプロイ方法によって異なります：

- **DIFY Cloud**: `https://api.dify.ai/v1/workflows/run`
- **セルフホスト**: `https://your-dify-instance.com/v1/workflows/run`

実際のWebhook URLは、DIFYダッシュボードのワークフロー設定画面で確認できます。

## ワークフローの設計例

DIFYのワークフロー機能を使用すると、より複雑な処理を実装できます：

1. **Webhookトリガー**: 職業（job）を受け取る
2. **LLMノード**: 質問生成プロンプトを実行
3. **出力ノード**: 3つの質問をリスト形式で出力

### ワークフロー図の例

```
[Webhookトリガー] → [LLMノード] → [出力ノード]
     (job)         (質問生成)      (結果)
```

## リクエスト形式

フロントエンドからDIFY Webhookに送信するリクエスト形式：

```json
{
  "inputs": {
    "job": "起業家"
  },
  "user": "webhook-user-1234567890"
}
```

## レスポンス形式

DIFYからの応答は、ワークフローの出力ノードの設定によって異なります。一般的には以下の形式：

```json
{
  "output": "① 最近、心から笑ったのはいつ？\n② あなたの誇りは？\n③ 今の自分に一言言うなら？"
}
```

または

```json
{
  "result": "..."
}
```

`script.js` の `generateQuestionsViaDify` 関数は、複数の応答形式に対応しています。

## メリット・デメリット

### メリット

- ✅ **APIキー管理が完全に不要**（Webhook方式ではAPIキー不要）
- ✅ **セキュア**（APIキーをクライアント側に露出しない）
- ✅ **ワークフローを視覚的に設計できる**
- ✅ **複数のLLMモデルを簡単に切り替え可能**
- ✅ **プロンプトの管理が簡単**
- ✅ **使用量の監視が可能**
- ✅ **GitHub Pagesで公開しても安全**

### デメリット

- ⚠️ DIFYの無料プランには制限がある場合がある
- ⚠️ カスタマイズの自由度がやや低い
- ⚠️ Webhook URLにトークンが含まれる場合は、公開リポジトリに含めない方が良い

## トラブルシューティング

### Webhook URLが見つからない

1. DIFYダッシュボードでワークフローを開く
2. 「公開」タブまたは「API」タブを確認
3. 「Webhook URL」または「Webhookエンドポイント」を探す
4. 見つからない場合は、ワークフローの「開始」ノードで「Webhook」トリガーが設定されているか確認

### レスポンス形式が異なる

DIFYのワークフローからの応答形式は、出力ノードの設定によって異なります。

1. ブラウザの開発者ツール（F12）でネットワークタブを開く
2. DIFY Webhookへのリクエストを確認
3. レスポンスの形式を確認
4. `script.js` の `generateQuestionsViaDify` 関数を、実際のレスポンス形式に合わせて調整

### 変数が正しく渡されない

1. DIFYのワークフローで、入力変数名が正しく設定されているか確認
2. フロントエンドの `inputs` オブジェクトのキー名が、DIFYの変数名と一致しているか確認
3. DIFYのワークフローで、変数の参照方法（`{{job}}` など）が正しいか確認

### 認証エラーが発生する

Webhook URLにトークンが含まれている場合、URL全体を正しくコピーしているか確認してください。
トークンが期限切れの場合は、DIFYダッシュボードで新しいWebhook URLを生成してください。

## 参考リンク

- [DIFY公式ドキュメント](https://docs.dify.ai/)
- [DIFY APIリファレンス](https://docs.dify.ai/guides/application-development/application-interface-api)

