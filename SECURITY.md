# セキュリティガイド：APIキーの管理方法

GitHub Pagesで一般公開する場合の、OpenAI APIキーの安全な管理方法について説明します。

## ⚠️ 重要な注意事項

**クライアントサイド（JavaScript）にAPIキーを直接埋め込むことは絶対に避けてください。**
- ブラウザの開発者ツールで誰でも簡単に取得できます
- GitHubリポジトリに公開すると、世界中の誰でも見ることができます
- APIキーが漏洩すると、不正利用による高額な請求が発生する可能性があります

## 推奨される方法（優先順位順）

### 1. バックエンドプロキシサーバーを使用（最もセキュア）⭐

**メリット：**
- APIキーがクライアント側に一切露出しない
- レート制限や使用量の管理が可能
- 最もセキュアな方法

**デメリット：**
- サーバーの維持費用がかかる
- サーバー側の実装が必要

**実装方法：**
- Node.js + Express でプロキシサーバーを構築
- APIキーを環境変数で管理
- クライアントはプロキシサーバーにリクエストを送信

### 2. サーバーレス関数を使用（セキュア）

**メリット：**
- サーバー管理が不要
- スケーラブル
- 無料枠がある場合が多い

**デメリット：**
- 各プラットフォームの設定が必要
- 無料枠を超えると課金

**利用可能なサービス：**
- **Vercel Functions** - 無料枠あり、簡単にセットアップ可能
- **Netlify Functions** - 無料枠あり
- **Cloudflare Workers** - 無料枠あり
- **AWS Lambda** - 従量課金

### 3. ユーザー各自がAPIキーを入力（現在の実装）

**メリット：**
- サーバー不要
- 実装が簡単
- ユーザー各自が自分のAPIキーを使用するため、運営者の負担がない

**デメリット：**
- ユーザーがAPIキーを取得する必要がある
- UXがやや複雑になる
- ユーザーのAPIキーが漏洩するリスク（ローカルストレージに保存）

**現在の実装：**
- 初回起動時にユーザーにAPIキーの入力を求める
- ローカルストレージに保存（同一デバイスのみ有効）

## 実装例：DIFY Webhookを使用（最も推奨・最もセキュア）⭐

DIFYのWebhookトリガーを使用することで、APIキーをクライアント側に一切露出させずに、ワークフローを視覚的に設計できます。

**メリット：**
- ✅ **APIキーをクライアント側に露出させない**（Webhook方式ではAPIキー不要）
- ✅ **ワークフローを視覚的に設計できる**
- ✅ **複数のLLMモデルに対応**
- ✅ **GitHub Pagesで公開しても安全**

**実装方法：**
1. DIFYでワークフローを作成し、Webhookトリガーを設定
2. Webhook URLを取得
3. フロントエンドからWebhook URLにリクエストを送信

**注意事項：**
- Webhook URLにトークンが含まれる場合は、公開リポジトリに含めない方が良い
- トークンが含まれない場合は、公開リポジトリに含めても比較的安全

詳細は `DIFY_SETUP.md` を参照してください。

## 実装例：バックエンドプロキシサーバー

`proxy-server/` ディレクトリに実装例を用意しています。

### セットアップ手順

1. プロキシサーバーをデプロイ（Heroku、Railway、Renderなど）
2. 環境変数に `OPENAI_API_KEY` を設定
3. `script.js` のAPIエンドポイントをプロキシサーバーのURLに変更

詳細は `proxy-server/README.md` を参照してください。

## 実装例：Vercel Functions

Vercelを使用する場合の実装例も提供しています。

詳細は `vercel-function/README.md` を参照してください。

## 本番環境での推奨設定

1. **バックエンドプロキシサーバー** または **サーバーレス関数** を使用
2. APIキーは環境変数で管理（絶対にコードに含めない）
3. レート制限を実装
4. 使用量の監視を設定
5. APIキーの定期的なローテーション

## 現在の実装について

現在の実装（ユーザー各自がAPIキーを入力）は、**小規模な個人プロジェクトやプロトタイプには適しています**が、一般公開する場合は以下の点に注意してください：

- ユーザーにAPIキーの取得方法を明確に案内する
- ローカルストレージのセキュリティリスクを説明する
- 可能であれば、バックエンドプロキシサーバーへの移行を検討する

